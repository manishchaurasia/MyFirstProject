<%@page import="java.sql.*,java.io.*,java.math.*,java.lang.*,java.util.Properties,javax.mail.*,javax.mail.internet.*"%><%@page import=" java.sql.Connection,java.sql.DriverManager,java.sql.ResultSet, java.sql.Statement"%> <%@page import="java.sql.*,java.io.*,java.math.*,java.lang.*,java.io.FileInputStream"%><%String stockname= request.getParameter("stockname");String quantity= request.getParameter("quantity");String currentprice= request.getParameter("currentprice");String username=request.getParameter("username");String firstname=request.getParameter("firstname");String lastname=request.getParameter("lastname");String previous_quantity="";double effective_quantity_value=0;String userbalance="";String to="";Properties prop = new Properties();String propFileName = "config.properties";InputStream inputStream = getClass().getClassLoader().getResourceAsStream(propFileName);prop.load(inputStream);final String PassWord=prop.getProperty("PassWord");final String from=prop.getProperty("from");try {          	       	                        DriverManager.registerDriver(new oracle.jdbc.driver.OracleDriver());            Connection connection = DriverManager.getConnection("jdbc:oracle:thin:@localhost:1521:XE", "system", "system");            Statement statement = connection.createStatement();			ResultSet resultset = statement.executeQuery("select stocksymbol,quantity from user_account where username='"+username+"' and stocksymbol='"+stockname+"'");			int count1=0;            while(resultset.next()){            	stockname=resultset.getString(1);				previous_quantity=resultset.getString(2);				count1++;	}			if(count1==1)			{				ResultSet resultset8 = statement.executeQuery("select email from accounts where username='"+username+"'");				while(resultset8.next()){            	 to=resultset8.getString(1);				}				double previous_quantity_value=Double.parseDouble(previous_quantity);				double quantity_value= Double.parseDouble(quantity);				double currentprice_value= Double.parseDouble(currentprice);				double effective_transation=(quantity_value*currentprice_value);				if(previous_quantity_value >= quantity_value)				{									effective_quantity_value=previous_quantity_value-quantity_value;				String effective_quantity_value_string = Double.toString(effective_quantity_value);				ResultSet resultset5 = statement.executeQuery("update user_account set quantity='"+effective_quantity_value_string+"' where username='"+username+"'and stocksymbol='"+stockname+"'" );								//Mail Code				Properties props = new Properties();  				props.put("mail.smtp.host", "smtp.gmail.com");  				props.put("mail.smtp.socketFactory.port", "465");  				props.put("mail.smtp.socketFactory.class","javax.net.ssl.SSLSocketFactory");  				props.put("mail.smtp.auth", "true");  				props.put("mail.smtp.port", "465");     				Session session1 = Session.getInstance(props,  				new javax.mail.Authenticator() {  				protected PasswordAuthentication getPasswordAuthentication() {  				return new PasswordAuthentication(from,PassWord);//change accordingly  				}  				});  				//compose message  				try {  				MimeMessage message = new MimeMessage(session1);  				message.setFrom(new InternetAddress(to));//change accordingly  				message.addRecipient(Message.RecipientType.TO,new InternetAddress(to));  				message.setSubject("Hello "+firstname+" "+lastname+"..!!You have just sell a stock");  				message.setText("You have Sell a stock "+stockname+" and Quantity :"+quantity_value);				System.out.println("You have sell a stock "+stockname+" and Quantity :"+quantity_value);					//send message  				Transport.send(message);  				} catch (MessagingException e) {throw new RuntimeException(e);} 											if(effective_quantity_value==0)				{					ResultSet resultset1 = statement.executeQuery("delete from user_account where username='"+username+"' and stocksymbol='"+stockname+"'" );					}								//update user balance								ResultSet resultset2 = statement.executeQuery("select userbalance from user_balance where username='"+username+"'");				while(resultset2.next()){				userbalance=resultset2.getString(1);				}				double userbalance_value= Double.parseDouble(userbalance);									userbalance_value=userbalance_value+effective_transation;				userbalance=Double.toString(userbalance_value);				ResultSet resultset3 = statement.executeQuery("update user_balance set userbalance='"+userbalance+"' where username='"+username+"'" );				}						}		    statement.close();              connection.close();              response.sendRedirect("StockBuddy_products.jsp?username="+username+"&firstname="+firstname+"&lastname="+lastname+"");			        } catch (Exception e) {              out.println("The exception raised is:" + e);          }%>